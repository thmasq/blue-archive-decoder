<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Archive Database Viewer (Direct DOM)</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        [x-cloak] { display: none !important; }

        .controls { 
            background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: flex; gap: 15px; align-items: center; flex-shrink: 0; flex-wrap: wrap;
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }
        .control-group { display: flex; align-items: center; gap: 8px; border-right: 1px solid #eee; padding-right: 15px; }
        .control-group:last-child { border-right: none; }
        
        select { padding: 8px; min-width: 150px; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        
        button.btn-primary {
            background-color: #1a73e8; color: white; border: none; padding: 8px 16px; 
            border-radius: 4px; cursor: pointer; font-weight: 500; transition: background 0.1s;
        }
        button.btn-primary:hover { background-color: #1557b0; }
        
        .range-slider { display: flex; align-items: center; gap: 8px; font-size: 13px; color: #555; }
        input[type=range] { width: 100px; }

        #status { margin-left: auto; color: #666; font-size: 14px; white-space: nowrap; }

        .header-viewport {
            flex-shrink: 0; 
            overflow: hidden; 
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-bottom: none;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            z-index: 10;
            position: relative;
        }

        #viewport { 
            flex-grow: 1; overflow: auto; background: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; border: 1px solid #dee2e6; 
        }
        
        .spacer { width: 1px; }

        table { 
            border-collapse: separate; 
            border-spacing: 0;
            table-layout: fixed;
            min-width: 100%; 
        }
        
        .header-viewport table { position: static; }
        #viewport table { position: absolute; top: 0; left: 0; }
        
        th, td { 
            border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; 
            padding: 0 8px; text-align: left; 
            box-sizing: border-box; font-size: 13px; 
            position: relative;
        }

        th { 
            background: #f8f9fa; 
            border-bottom: 1px solid #ccc; 
            font-weight: 600; color: #444; user-select: none;
            height: 35px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .resizer {
            position: absolute; right: 0; top: 0; bottom: 0; width: 5px;
            cursor: col-resize; user-select: none; z-index: 11;
        }
        .resizer:hover, .is-resizing .resizer { background-color: #1a73e8; }

        tbody tr { background: white; }
        tbody tr:hover { background-color: #f1f3f4; }

        .cell-content {
            width: 100%; height: 100%;
            display: flex; align-items: center;
        }
        
        .mode-truncate .cell-content {
            white-space: nowrap; overflow: hidden; display: block; 
            text-overflow: ellipsis; line-height: inherit;
        }
        
        .mode-wrap .cell-content {
            white-space: normal; word-break: break-word; display: block;
            overflow: hidden; 
        }

        .col-index { 
            background: #fcfcfc; border-right: 2px solid #e0e0e0; color: #999; text-align: center;
        }

        .type-null { color: #aaa; font-style: italic; }
        .type-number { text-align: right; color: #1a73e8; font-variant-numeric: tabular-nums; }
        .type-blob { color: #d93025; font-family: monospace; font-size: 11px; }

        .modal-overlay { 
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.3); display: flex; align-items: flex-start; 
            justify-content: center; padding-top: 80px; backdrop-filter: blur(2px);
        }
        .modal-content { 
            background-color: #fff; padding: 20px; border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 450px; display: flex; 
            flex-direction: column; gap: 15px; 
        }
        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: 600; font-size: 18px; color: #333; }
        .modal-hint { font-size: 12px; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 4px; }
        #modalSearchInput { 
            padding: 12px; font-size: 16px; border: 2px solid #1a73e8; border-radius: 8px; 
            width: 100%; box-sizing: border-box; outline: none; 
        }
        .modal-footer { display: flex; justify-content: space-between; font-size: 13px; color: #666; }
    </style>
</head>
<body x-data="dbViewer" :class="{ 'is-resizing': resizingCol !== -1 }">

    <div class="controls">
        <div class="control-group">
            <input type="file" @change="loadFile($event)" accept=".db,.sqlite,.sqlite3">
        </div>
        
        <div class="control-group" x-show="tables.length > 0" x-cloak>
            <select x-model="currentTable" @change="loadTable()">
                <option value="" disabled selected>Select Table</option>
                <template x-for="t in tables" :key="t">
                    <option :value="t" x-text="t"></option>
                </template>
            </select>
        </div>

        <div class="control-group" x-show="totalRows > 0" x-cloak>
            <div class="range-slider" title="Adjust Row Height">
                <span>Height:</span>
                <input type="range" min="30" max="150" x-model.number="rowHeight" @input="updateScroll">
                <span x-text="`${rowHeight}px`"></span>
            </div>
        </div>
        
        <button class="btn-primary" 
                x-show="totalRows > 0" 
                @click="openSearch" 
                x-cloak>
            Find / Filter
        </button>

        <button class="btn-primary" 
                x-show="totalRows > 0" 
                @click="exportTable" 
                style="margin-left: 8px;"
                x-cloak>
            Export CSV
        </button>
        
        <span id="status" x-text="statusText"></span>
    </div>
    
    <div class="header-viewport" x-ref="headerPane" x-show="columns.length > 0">
        <table :style="`width: ${getTableWidth()}px`">
            <thead>
                <tr>
                    <th class="col-index" style="width: 60px">#</th>
                    <template x-for="(col, idx) in columns" :key="col">
                        <th :style="`width: ${colWidths[idx]}px`">
                            <span x-text="col" style="padding-right: 5px;"></span>
                            <div class="resizer" @mousedown.stop.prevent="startResize($event, idx)"></div>
                        </th>
                    </template>
                </tr>
            </thead>
        </table>
    </div>

    <div id="viewport" x-ref="viewport"
         x-virtual-scroll="{ buffer: 10, handler: 'updateSlice' }"
         @scroll="syncHeader">
        
        <div class="spacer" :style="`height: ${totalRows * rowHeight}px; width: 1px`"></div>
        
        <table id="grid" :style="`transform: translateY(${offsetY}px); width: ${getTableWidth()}px`">
            <colgroup>
                <col style="width: 60px"> <template x-for="w in colWidths">
                    <col :style="`width: ${w}px`">
                </template>
            </colgroup>

            <tbody id="grid-body" :class="wrapText ? 'mode-wrap' : 'mode-truncate'">
                </tbody>
        </table>
    </div>

    <div class="modal-overlay" 
         x-show="isSearchOpen" 
         x-transition.opacity
         @click.self="closeSearch"
         @keydown.escape.window="closeSearch"
         @keydown.window="if (($event.ctrlKey || $event.metaKey) && $event.key === 'f') { $event.preventDefault(); openSearch(); }"
         x-cloak>
         
        <div class="modal-content" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-[-20px]" x-transition:enter-end="opacity-100 translate-y-0">
            <div class="modal-header">
                <span class="modal-title">Filter Table</span>
                <span class="modal-hint">ESC to close</span>
            </div>
            
            <input type="text" 
                   id="modalSearchInput" 
                   x-ref="searchInput"
                   placeholder="Type to filter rows..." 
                   autocomplete="off"
                   x-model="searchQuery"
                   @input.debounce.150ms="applyFilter">
                   
            <div class="modal-footer">
                <span x-text="searchQuery === '' ? 'Showing all rows' : `${totalRows.toLocaleString()} matches found`"></span>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { Inspector } from './pkg/blue_archive_decoder.js'; 
        import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/module.esm.js';

        let inspector = null;

        Alpine.directive('virtual-scroll', (el, { expression }, { evaluateLater, effect }) => {
            const config = evaluateLater(expression);
            let opts = {};
            config(result => { opts = result });

            const buffer = opts.buffer || 15;
            const handlerName = opts.handler;
            
            let lastStart = -1;
            let isScrolling = false;

            const onScroll = () => {
                const data = Alpine.$data(el); 
                const total = data.totalRows;
                const rowHeight = data.rowHeight;

                if (total === 0) {
                    if (lastStart !== -1 || data._forceUpdate) {
                        lastStart = -1;
                        data._forceUpdate = false;
                        data[handlerName](0, 0);
                    }
                    return;
                }

                const scrollTop = el.scrollTop;
                const clientHeight = el.clientHeight;
                
                const startNode = Math.floor(scrollTop / rowHeight);
                const endNode = Math.min(total, Math.ceil((scrollTop + clientHeight) / rowHeight));

                const renderStart = Math.max(0, startNode - buffer);
                const renderEnd = Math.min(total, endNode + buffer);
                const count = renderEnd - renderStart;

                if (count <= 0) return;

                if (renderStart !== lastStart || data._forceUpdate) {
                    lastStart = renderStart;
                    data._forceUpdate = false;
                    data[handlerName](renderStart, count);
                }
            };

            el.addEventListener('scroll', () => {
                if(!isScrolling) {
                    requestAnimationFrame(() => {
                        onScroll();
                        isScrolling = false;
                    });
                    isScrolling = true;
                }
            });

            effect(() => {
                const data = Alpine.$data(el);
                const _h = data.rowHeight; 
                const _t = data.totalRows; 
                data._forceUpdate = true; 
                onScroll();
            });
        });

        Alpine.data('dbViewer', () => ({
            statusText: 'Waiting for file...',
            tables: [],
            currentTable: '',
            columns: [],
            colWidths: [],
            totalRows: 0,
            offsetY: 0,
            
            // View Settings
            rowHeight: 30,
            wrapText: true,
            
            // Search
            isSearchOpen: false,
            searchQuery: '',

            // Resize State
            resizingCol: -1,
            startX: 0,
            startWidth: 0,
            _forceUpdate: false,

            async init() {
                try {
                    await init(); 
                    window.addEventListener('mouseup', () => this.stopResize());
                    window.addEventListener('mousemove', (e) => this.onMouseMove(e));
                } catch(e) {
                    console.error("WASM Init Fail", e);
                }
            },

            syncHeader(e) {
                if (this.$refs.headerPane) {
                    this.$refs.headerPane.scrollLeft = e.target.scrollLeft;
                }
            },

            loadFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                this.statusText = "Processing database...";
                
                reader.onload = () => {
                    try {
                        if (inspector) inspector.free();
                        const data = new Uint8Array(reader.result);
                        inspector = new Inspector(data);
                        
                        this.tables = inspector.get_tables();
                        this.statusText = `Loaded. ${this.tables.length} tables found.`;
                        this.resetView();
                    } catch (err) {
                        console.error(err);
                        this.statusText = "Error: " + err;
                    }
                };
                reader.readAsArrayBuffer(file);
            },

            loadTable() {
                if (!inspector || !this.currentTable) return;
                try {
                    this.totalRows = inspector.load_table(this.currentTable);
                    this.columns = JSON.parse(inspector.get_columns());
                    this.colWidths = new Array(this.columns.length).fill(150);
                    
                    this.searchQuery = "";
                    this.statusText = `${this.totalRows.toLocaleString()} rows`;

                    if (this.$refs.viewport) {
                        this.$refs.viewport.scrollTop = 0;
                    }
                } catch (err) {
                    this.statusText = "Error loading table: " + err;
                }
            },

            updateSlice(start, count) {
                if (!inspector) return;

                try {
                    inspector.render_rows("grid-body", start, count, this.rowHeight);
                    this.offsetY = start * this.rowHeight;
                } catch (e) {
                    console.error("Render failed", e);
                }
            },

            startResize(e, idx) {
                this.resizingCol = idx;
                this.startX = e.clientX;
                this.startWidth = this.colWidths[idx];
            },

            onMouseMove(e) {
                if (this.resizingCol === -1) return;
                const diff = e.clientX - this.startX;
                const newWidth = Math.max(50, this.startWidth + diff); 
                this.colWidths[this.resizingCol] = newWidth;
            },

            stopResize() {
                this.resizingCol = -1;
            },
            
            getTableWidth() {
                if (this.colWidths.length === 0) return '100%';
                const sum = this.colWidths.reduce((a, b) => a + b, 0);
                return sum + 60; // +60 for index col
            },
            
            updateScroll() {
                this._forceUpdate = true;
            },

            openSearch() {
                this.isSearchOpen = true;
                this.$nextTick(() => this.$refs.searchInput.focus());
            },
            
            closeSearch() {
                this.isSearchOpen = false;
            },

            applyFilter() {
                if (!inspector) return;
                this.totalRows = inspector.apply_filter(this.searchQuery);
                this.statusText = `${this.totalRows.toLocaleString()} rows (filtered)`;

                if (this.$refs.viewport) {
                    this.$refs.viewport.scrollTop = 0;
                }
            },

            exportTable() {
                if (!inspector || !this.currentTable) return;
                
                try {
                    const csvContent = inspector.export_csv();
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    
                    const url = URL.createObjectURL(blob);
                    const link = document.createElement("a");
                    link.setAttribute("href", url);
                    link.setAttribute("download", `${this.currentTable}.csv`);
                    document.body.appendChild(link);
                    
                    link.click();
                    
                    document.body.removeChild(link);
                    URL.revokeObjectURL(url);
                } catch (e) {
                    alert("Export failed: " + e);
                    console.error(e);
                }
            },

            resetView() {
                this.columns = [];
                this.colWidths = [];
                this.totalRows = 0;
                this.currentTable = "";
                const el = document.getElementById('grid-body');
                if (el) el.innerHTML = "";
            }
        }));

        Alpine.start();
    </script>
</body>
</html>
