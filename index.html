<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Blue Archive Database Viewer (Alpine.js)</title>
    <style>
        html, body { height: 100%; margin: 0; padding: 0; overflow: hidden; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: #f0f2f5; 
            display: flex; 
            flex-direction: column; 
            padding: 20px; 
            box-sizing: border-box; 
        }
        [x-cloak] { display: none !important; }

        .controls { 
            background: white; padding: 15px; border-radius: 8px; margin-bottom: 20px; 
            display: flex; gap: 15px; align-items: center; flex-shrink: 0; 
            box-shadow: 0 1px 2px rgba(0,0,0,0.05); 
        }
        select { padding: 8px; min-width: 200px; border: 1px solid #ccc; border-radius: 4px; background-color: white; }
        
        button.btn-search {
            background-color: #1a73e8; color: white; border: none; padding: 8px 16px; 
            border-radius: 4px; cursor: pointer; font-weight: 500; transition: background 0.1s;
        }
        button.btn-search:hover { background-color: #1557b0; }
        button.btn-search:disabled { background-color: #ccc; cursor: not-allowed; }

        #status { margin-left: auto; color: #666; font-size: 14px; white-space: nowrap; }

        #viewport { 
            flex-grow: 1; overflow: auto; background: white; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.1); position: relative; border: 1px solid #dee2e6; 
        }
        
        .spacer { width: 1px; }

        table { border-collapse: collapse; table-layout: fixed; width: 100%; position: absolute; top: 0; left: 0; }
        
        th, td { 
            border-right: 1px solid #e0e0e0; border-bottom: 1px solid #e0e0e0; 
            padding: 0 8px; text-align: left; white-space: nowrap; overflow: hidden; 
            text-overflow: ellipsis; height: 30px; box-sizing: border-box; font-size: 13px; 
        }
        
        thead { position: sticky; top: 0; z-index: 2; background: #f8f9fa; display: block; }
        thead tr { display: flex; }
        thead th { 
            flex: 1; border-bottom: 2px solid #ccc; display: flex; align-items: center; 
            font-weight: 600; color: #444; user-select: none;
        }
        
        tbody tr { display: flex; background: white; }
        tbody td { flex: 1; display: flex; align-items: center; }
        tbody tr:hover { background-color: #e8f0fe; }

        .col-index { 
            width: 60px !important; flex: none !important; color: #999; justify-content: center; 
            background: #fcfcfc; border-right: 2px solid #e0e0e0; user-select: none; 
        }
        .type-null { color: #aaa; font-style: italic; }
        .type-number { justify-content: flex-end; color: #1a73e8; font-variant-numeric: tabular-nums; }
        .type-blob { color: #d93025; font-family: monospace; font-size: 11px; }

        .modal-overlay { 
            position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; 
            background-color: rgba(0,0,0,0.3); display: flex; align-items: flex-start; 
            justify-content: center; padding-top: 80px; backdrop-filter: blur(2px);
        }
        
        .modal-content { 
            background-color: #fff; padding: 20px; border-radius: 12px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.2); width: 450px; display: flex; 
            flex-direction: column; gap: 15px; 
        }

        .modal-header { display: flex; justify-content: space-between; align-items: center; }
        .modal-title { font-weight: 600; font-size: 18px; color: #333; }
        .modal-hint { font-size: 12px; color: #666; background: #f0f0f0; padding: 4px 8px; border-radius: 4px; }
        
        #modalSearchInput { 
            padding: 12px; font-size: 16px; border: 2px solid #1a73e8; border-radius: 8px; 
            width: 100%; box-sizing: border-box; outline: none; 
        }
        
        .modal-footer { display: flex; justify-content: space-between; font-size: 13px; color: #666; }
    </style>
</head>
<body x-data="dbViewer">

    <div class="controls">
        <input type="file" @change="loadFile($event)" accept=".db,.sqlite,.sqlite3">
        
        <select x-show="tables.length > 0" x-model="currentTable" @change="loadTable()" x-cloak>
            <option value="" disabled selected>Select Table</option>
            <template x-for="t in tables" :key="t">
                <option :value="t" x-text="t"></option>
            </template>
        </select>
        
        <button class="btn-search" 
                x-show="totalRows > 0" 
                @click="openSearch" 
                x-cloak>
            Find / Filter
        </button>
        
        <span id="status" x-text="statusText"></span>
    </div>
    
    <div id="viewport" x-virtual-scroll="{ rowHeight: 30, buffer: 15, handler: 'updateSlice' }">
        
        <div class="spacer" :style="`height: ${totalRows * 30}px`"></div>
        
        <table id="grid" :style="`transform: translateY(${offsetY}px)`">
            <thead>
                <tr>
                    <th class="col-index">#</th>
                    <template x-for="col in columns" :key="col">
                        <th x-text="col" :title="col"></th>
                    </template>
                </tr>
            </thead>
            <tbody>
                <template x-for="row in rows" :key="row[0]">
                    <tr>
                        <td class="col-index" x-text="row[0]"></td>
                        <template x-for="(val, idx) in row.slice(1)">
                            <td :class="getCellClass(val)" x-text="formatCell(val)"></td>
                        </template>
                    </tr>
                </template>
            </tbody>
        </table>
    </div>

    <div class="modal-overlay" 
         x-show="isSearchOpen" 
         x-transition.opacity
         @click.self="closeSearch"
         @keydown.escape.window="closeSearch"
         @keydown.window="if (($event.ctrlKey || $event.metaKey) && $event.key === 'f') { $event.preventDefault(); openSearch(); }"
         x-cloak>
         
        <div class="modal-content" x-transition:enter="transition ease-out duration-200" x-transition:enter-start="opacity-0 translate-y-[-20px]" x-transition:enter-end="opacity-100 translate-y-0">
            <div class="modal-header">
                <span class="modal-title">Filter Table</span>
                <span class="modal-hint">ESC to close</span>
            </div>
            
            <input type="text" 
                   id="modalSearchInput" 
                   x-ref="searchInput"
                   placeholder="Type to filter rows..." 
                   autocomplete="off"
                   x-model="searchQuery"
                   @input.debounce.150ms="applyFilter">
                   
            <div class="modal-footer">
                <span x-text="searchQuery === '' ? 'Showing all rows' : `${totalRows.toLocaleString()} matches found`"></span>
            </div>
        </div>
    </div>

    <script type="module">
        import init, { Inspector } from './pkg/blue_archive_decoder.js'; 
        import Alpine from 'https://cdn.jsdelivr.net/npm/alpinejs@3.13.3/dist/module.esm.js';

        let inspector = null;

        Alpine.directive('virtual-scroll', (el, { expression }, { evaluateLater, effect }) => {
            const config = evaluateLater(expression);
            let opts = {};
            config(result => { opts = result });

            const rowHeight = opts.rowHeight || 30;
            const buffer = opts.buffer || 15;
            const handlerName = opts.handler;
            
            let lastStart = -1;
            let isScrolling = false;

            const onScroll = () => {
                const data = Alpine.$data(el); 
                const total = data.totalRows; 
                
                if (total === 0) return;

                const scrollTop = el.scrollTop;
                const clientHeight = el.clientHeight;
                
                const startNode = Math.floor(scrollTop / rowHeight);
                const endNode = Math.min(total, Math.ceil((scrollTop + clientHeight) / rowHeight));

                const renderStart = Math.max(0, startNode - buffer);
                const renderEnd = Math.min(total, endNode + buffer);
                const count = renderEnd - renderStart;

                if (count <= 0) return;

                if (renderStart !== lastStart) {
                    lastStart = renderStart;
                    data[handlerName](renderStart, count);
                }
            };

            el.addEventListener('scroll', () => {
                if(!isScrolling) {
                    requestAnimationFrame(() => {
                        onScroll();
                        isScrolling = false;
                    });
                    isScrolling = true;
                }
            });

            effect(() => {
                const data = Alpine.$data(el);
                const _ = data.totalRows; 
                el.scrollTop = 0;
                lastStart = -1;
                onScroll();
            });
        });

        Alpine.data('dbViewer', () => ({
            statusText: 'Waiting for file...',
            tables: [],
            currentTable: '',
            columns: [],
            rows: [],
            totalRows: 0,
            offsetY: 0,
            isSearchOpen: false,
            searchQuery: '',

            async init() {
                try {
                    await init(); 
                } catch(e) {
                    console.error("WASM Init Fail", e);
                }
            },

            loadFile(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                this.statusText = "Processing database...";
                
                reader.onload = () => {
                    try {
                        if (inspector) inspector.free();
                        const data = new Uint8Array(reader.result);
                        inspector = new Inspector(data);
                        
                        this.tables = inspector.get_tables();
                        this.statusText = `Loaded. ${this.tables.length} tables found.`;
                        this.resetView();
                    } catch (err) {
                        console.error(err);
                        this.statusText = "Error: " + err;
                    }
                };
                reader.readAsArrayBuffer(file);
            },

            loadTable() {
                if (!inspector || !this.currentTable) return;
                try {
                    this.totalRows = inspector.load_table(this.currentTable);
                    this.columns = JSON.parse(inspector.get_columns());
                    this.searchQuery = "";
                    this.statusText = `${this.totalRows.toLocaleString()} rows`;
                } catch (err) {
                    this.statusText = "Error loading table: " + err;
                }
            },

            updateSlice(start, count) {
                if (!inspector) return;
                const json = inspector.get_rows_slice(start, count);
                this.rows = JSON.parse(json);
                this.offsetY = start * 30;
            },

            openSearch() {
                this.isSearchOpen = true;
                this.$nextTick(() => this.$refs.searchInput.focus());
            },
            
            closeSearch() {
                this.isSearchOpen = false;
            },

            applyFilter() {
                if (!inspector) return;
                this.totalRows = inspector.apply_filter(this.searchQuery);
                this.statusText = `${this.totalRows.toLocaleString()} rows (filtered)`;
            },

            resetView() {
                this.rows = [];
                this.columns = [];
                this.totalRows = 0;
                this.currentTable = "";
            },

            getCellClass(val) {
                if (val === null) return 'type-null';
                if (typeof val === 'number') return 'type-number';
                if (val === "<blob>") return 'type-blob';
                return '';
            },

            formatCell(val) {
                if (val === null) return 'NULL';
                if (val === "<blob>") return 'BLOB';
                return val;
            }
        }));

        Alpine.start();
    </script>
</body>
</html>
